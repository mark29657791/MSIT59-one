function initializeDraggable() {
    // 使列表項目可拖動
    $("li", "#gallery").draggable({
        cancel: "a.ui-icon",
        revert: "invalid",
        containment: "document",
        helper: "clone",
        cursor: "move"
    });

    var $scheduleAreas = $("#first-day-morning, #first-day-afternoon, #first-day-evening, #first-day-night, #second-day-morning, #second-day-afternoon, #second-day-evening, #second-day-night, #third-day-morning, #third-day-afternoon, #third-day-evening, #third-day-night");

    // 使區域可放置
    $scheduleAreas.droppable({
        accept: "#gallery > li",
        classes: {
            "ui-droppable-active": "ui-state-highlight"
        },
        // 處理將項目拖放到區域的情況
        drop: function(event, ui) {
            var $schedule = $(this);
            var $existingItem = $schedule.find("li");

            if ($existingItem.length) {
                recycleImage($existingItem);
            }

            deleteImage(ui.draggable, $schedule);
        }
    });

    // 回收圖片的函數
    function recycleImage($item) {
        var trash_icon = "<a href='#' title='刪除此圖片' class='ui-icon ui-icon-trash'>刪除圖片</a>";
        $item.fadeOut(function() {
            $item.find("a.ui-icon-refresh").remove().end()
                .append(trash_icon)
                .appendTo("#gallery").fadeIn(function() {
                    $item.find('img').css('height', $item.data('original-height'));
                });

            $item.draggable({
                revert: true,
                containment: "document",
                cursor: "move",
                helper: "original"
            });
        });
    }

    // 點擊圖庫項目的事件監聽器
    $("ul.gallery > li").on("click", function(event) {
        var $item = $(this),
            $target = $(event.target);

        if ($target.is("a.ui-icon-trash")) {
            deleteImage($item);
        } else if ($target.is("a.ui-icon-zoomin")) {
            viewLargerImage($target);
        } else if ($target.is("a.ui-icon-refresh")) {
            recycleImage($item);
        }
        return false;
    });

    function deleteImage($item, $target) {
        $item.fadeOut(function() {
            var $list = $("ul", $target).length ?
                $("ul", $target) :
                $("<ul class='gallery ui-helper-reset'/>").appendTo($target);

            $item.appendTo($list).fadeIn(function() {
                $item
                    .animate({ width: "96px" })
                    .find("img")
                    .animate({ height: "72px" });
            });
        });
    }

    function viewLargerImage($link) {
        var src = $link.attr("href"),
            $modal = $("img[src$='" + src + "']");

        if ($modal.length) {
            $modal.dialog("open");
        } else {
            var img = $("<img alt='圖片' style='display: none; padding: 8px;' />")
                .attr("src", src)
                .appendTo("body");
            setTimeout(function() {
                img.dialog({
                    title: "圖片預覽",
                    width: 400,
                    modal: true
                });
            }, 1);
        }
    }
}

$(document).ready(function() {
    initializeDraggable();

    $(".accordion").click(function() {
        this.classList.toggle("active");
        var panel = this.nextElementSibling;
        if (panel.style.maxHeight) {
            panel.style.maxHeight = null;
        } else {
            panel.style.maxHeight = panel.scrollHeight + "px";
        }
    });
});
